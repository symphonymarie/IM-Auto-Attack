{
  "Auto-Target": {
    "name": "Auto-Target",
    "type": "script",
    "author": "IMAA Token Manager Module", 
    "img": "icons/svg/target.svg",
    "scope": "global",
    "command": "const token = canvas.tokens.controlled[0];\nif (!token) {\n    ui.notifications.warn(\"Please select a token first.\");\n    return;\n}\n\n// Check token disposition\nconst disposition = token.document.disposition;\nconst isHostile = disposition === CONST.TOKEN_DISPOSITIONS.HOSTILE;\n\nlet targetTokens = [];\n\nif (isHostile) {\n    // Hostile tokens target anything that's NOT hostile (players, friendly, neutral)\n    targetTokens = canvas.tokens.placeables.filter(t => {\n        if (!t.actor || t.document.hidden || t.id === token.id) return false;\n        \n        // Target any token that is NOT hostile\n        return t.document.disposition !== CONST.TOKEN_DISPOSITIONS.HOSTILE;\n    });\n} else {\n    // Friendly/neutral tokens target hostile tokens only\n    targetTokens = canvas.tokens.placeables.filter(t => \n        t.actor && \n        t.document.disposition === CONST.TOKEN_DISPOSITIONS.HOSTILE &&\n        !t.document.hidden\n    );\n}\n\nif (targetTokens.length === 0) {\n    ui.notifications.warn(\"No valid targets found.\");\n    return;\n}\n\n// Find nearest target token, using priority to break distance ties\nconst nearest = targetTokens.reduce((closest, t) => {\n    const distance = canvas.grid.measureDistance(token.center, t.center);\n    \n    // If no closest target yet, this one becomes closest\n    if (!closest) {\n        return { token: t, distance, priority: getPriority(t) };\n    }\n    \n    // If this token is closer, it becomes the new closest\n    if (distance < closest.distance) {\n        return { token: t, distance, priority: getPriority(t) };\n    }\n    \n    // If distance is equal, use priority to break tie\n    if (distance === closest.distance) {\n        const currentPriority = getPriority(t);\n        if (currentPriority > closest.priority) {\n            return { token: t, distance, priority: currentPriority };\n        }\n    }\n    \n    return closest;\n}, null);\n\nif (!nearest) {\n    ui.notifications.warn(\"No valid targets found.\");\n    return;\n}\n\n// Target the selected token\nnearest.token.setTarget(true, { user: game.user, releaseOthers: true });\nui.notifications.info(`Targeting ${nearest.token.name}`);\n\n// Helper function to assign priority values (players > friendly > neutral)\nfunction getPriority(targetToken) {\n    if (targetToken.actor.hasPlayerOwner) return 3; // Players - highest priority\n    if (targetToken.document.disposition === CONST.TOKEN_DISPOSITIONS.FRIENDLY) return 2;\n    if (targetToken.document.disposition === CONST.TOKEN_DISPOSITIONS.NEUTRAL) return 1;\n    return 0;\n}",
    "folder": "IMAA Combat Macros",
    "flags": {},
    "_stats": {
      "coreVersion": "13.348",
      "systemId": "impmal", 
      "systemVersion": "3.0.4"
    }
  },
  "Default-Attack": {
    "name": "Default-Attack",
    "type": "script",
    "author": "IMAA Token Manager Module",
    "img": "icons/svg/sword.svg",
    "scope": "global", 
    "command": "const token = canvas.tokens.controlled[0];\nif (!token) {\n    ui.notifications.warn(\"Please select a token first.\");\n    return;\n}\n\n// Check token disposition\nconst disposition = token.document.disposition;\nconst isHostile = disposition === CONST.TOKEN_DISPOSITIONS.HOSTILE;\n\nlet targetTokens = [];\n\nif (isHostile) {\n    // Hostile tokens target anything that's NOT hostile (players, friendly, neutral)\n    targetTokens = canvas.tokens.placeables.filter(t => {\n        if (!t.actor || t.document.hidden || t.id === token.id) return false;\n        \n        // Target any token that is NOT hostile\n        return t.document.disposition !== CONST.TOKEN_DISPOSITIONS.HOSTILE;\n    });\n} else {\n    // Friendly/neutral tokens target hostile tokens only\n    targetTokens = canvas.tokens.placeables.filter(t => \n        t.actor && \n        t.document.disposition === CONST.TOKEN_DISPOSITIONS.HOSTILE &&\n        !t.document.hidden\n    );\n}\n\nif (targetTokens.length === 0) {\n    ui.notifications.warn(\"No valid targets found.\");\n    return;\n}\n\n// Find nearest target token, using priority to break distance ties\nconst nearest = targetTokens.reduce((closest, t) => {\n    const distance = canvas.grid.measureDistance(token.center, t.center);\n    \n    // If no closest target yet, this one becomes closest\n    if (!closest) {\n        return { token: t, distance, priority: getPriority(t) };\n    }\n    \n    // If this token is closer, it becomes the new closest\n    if (distance < closest.distance) {\n        return { token: t, distance, priority: getPriority(t) };\n    }\n    \n    // If distance is equal, use priority to break tie\n    if (distance === closest.distance) {\n        const currentPriority = getPriority(t);\n        if (currentPriority > closest.priority) {\n            return { token: t, distance, priority: currentPriority };\n        }\n    }\n    \n    return closest;\n}, null);\n\nif (!nearest) {\n    ui.notifications.warn(\"No valid targets found.\");\n    return;\n}\n\n// Target the selected token\nnearest.token.setTarget(true, { user: game.user, releaseOthers: true });\nui.notifications.info(`Targeting ${nearest.token.name}`);\n\n// Get available attacks\nconst actor = token.actor;\nif (!actor) {\n    ui.notifications.error(\"No actor associated with selected token\");\n    return;\n}\n\n// Calculate distance in grid squares more accurately\nconst tokenPosition = token.center;\nconst targetPosition = nearest.token.center;\nconst gridSize = canvas.grid.size;\n\n// Calculate the difference in grid units\nconst dx = Math.abs(tokenPosition.x - targetPosition.x) / gridSize;\nconst dy = Math.abs(tokenPosition.y - targetPosition.y) / gridSize;\n\n// Use the maximum of dx and dy for grid-based distance (chebyshev distance)\nconst gridDistance = Math.max(dx, dy);\n\nconst isWithinOneSquare = gridDistance <= 1;\n\n// Get attacks\nconst meleeAttacks = actor.items.filter(i => i.name.endsWith(\"*\") && !i.name.endsWith(\"*R\"));\nconst rangedAttacks = actor.items.filter(i => i.name.endsWith(\"*R\"));\n\n// Function to execute a random attack\nfunction executeRandomAttack(attacks, attackType) {\n    if (attacks.length === 0) {\n        ui.notifications.warn(`No ${attackType} attacks found.`);\n        return;\n    }\n    \n    // Select one random attack\n    const randomAttack = attacks[Math.floor(Math.random() * attacks.length)];\n    const itemUUID = randomAttack.uuid;\n    game.impmal.utility.rollItemMacro(itemUUID, actor);\n    ui.notifications.info(`Using ${attackType} attack: ${randomAttack.name}`);\n}\n\n// Handle based on distance\nif (isWithinOneSquare) {\n    // Target is within 1 square - use random melee attack\n    executeRandomAttack(meleeAttacks, \"melee\");\n} else {\n    // Target is more than 1 square away - show dialog\n    new Dialog({\n        title: \"Target not in immediate range. Please choose an action.\",\n        content: `\n            <div style=\"padding: 10px;\">\n                <p>Target is ${Math.ceil(gridDistance)} squares away.</p>\n            </div>\n        `,\n        buttons: {\n            continue: {\n                icon: '<i class=\"fas fa-bullseye\"></i>',\n                label: \"Ranged Attack\",\n                callback: () => {\n                    executeRandomAttack(rangedAttacks, \"ranged\");\n                }\n            },\n            cancel: {\n                icon: '<i class=\"fas fa-walking\"></i>',\n                label: \"Cancel and Move\",\n                callback: () => {\n                    ui.notifications.info(\"Attack canceled. You may now move your token.\");\n                }\n            }\n        },\n        default: \"continue\"\n    }).render(true);\n}\n\n// Helper function to assign priority values (players > friendly > neutral)\nfunction getPriority(targetToken) {\n    if (targetToken.actor.hasPlayerOwner) return 3; // Players - highest priority\n    if (targetToken.document.disposition === CONST.TOKEN_DISPOSITIONS.FRIENDLY) return 2;\n    if (targetToken.document.disposition === CONST.TOKEN_DISPOSITIONS.NEUTRAL) return 1;\n    return 0;\n}",
    "folder": "IMAA Combat Macros",
    "flags": {},
    "_stats": {
      "coreVersion": "13.348",
      "systemId": "impmal",
      "systemVersion": "3.0.4"
    }
  },
  "Target-Player": {
    "name": "Target-Player", 
    "type": "script",
    "author": "IMAA Token Manager Module",
    "img": "icons/svg/eye.svg",
    "scope": "global",
    "command": "const token = canvas.tokens.controlled[0];\nif (!token) {\n    ui.notifications.warn(\"Please select a token first.\");\n    return;\n}\n\n// Get all player-owned tokens\nconst playerTokens = canvas.tokens.placeables.filter(t => \n    t.actor && t.actor.hasPlayerOwner && !t.document.hidden\n);\n\nif (playerTokens.length === 0) {\n    ui.notifications.warn(\"No player tokens found.\");\n    return;\n}\n\n// Find nearest player token\nconst nearest = playerTokens.reduce((closest, t) => {\n    if (t.id === token.id) return closest; // Skip self\n    \n    const distance = canvas.grid.measureDistance(token.center, t.center);\n    return !closest || distance < closest.distance ? \n        { token: t, distance } : closest;\n}, null);\n\nif (!nearest) {\n    ui.notifications.warn(\"No valid targets found.\");\n    return;\n}\n\n// Target the nearest token\nnearest.token.setTarget(true, { user: game.user, releaseOthers: true });\nui.notifications.info(`Targeting ${nearest.token.name}`);",
    "folder": "IMAA Combat Macros",
    "flags": {},
    "_stats": {
      "coreVersion": "13.348",
      "systemId": "impmal",
      "systemVersion": "3.0.4"
    }
  }
}